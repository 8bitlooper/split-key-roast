var mainChart;
var auxChart;

$(document).ready(function () {
    Highcharts.getSVG = function(charts, options, callback) {
        var svgArr = [],
            top = 10,
            width = 10,
            addSVG = function(svgres) {
                var svgWidth = +svgres.match(
                        /^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/
                    )[1],
                    svgHeight = +svgres.match(
                        /^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/
                    )[1],
                    // Offset the position of this chart in the final SVG
                    svg = svgres.replace('<svg', '<g transform="translate(10,' + top + ')" ');
                svg = svg.replace('</svg>', '</g>');
                top += svgHeight + 10;
                width = Math.max(width, svgWidth) + 10;
                svgArr.push(svg);
            },
            exportChart = function(i) {
                if (i === charts.length) {
                    return callback('<svg height="' + top + '" width="' + width +
                        '" version="1.1" xmlns="http://www.w3.org/2000/svg">' + svgArr.join('') + '</svg>');
                }
                charts[i].getSVGForLocalExport(options, {}, function() {
                    console.log("Failed to get SVG");
                }, function(svg) {
                    addSVG(svg);
                    return exportChart(i + 1); // Export next only when this SVG is received
                });
            };
        exportChart(0);
    };

    Highcharts.exportCharts = function (charts, options) {
        options = Highcharts.merge(Highcharts.getOptions().exporting, options);
        Highcharts.getSVG(charts, options, function (svg) {
            Highcharts.downloadSVGLocal(svg, options, function () {
                console.log("Failed to export on client side");
            });
        });
    };

    $('#container').bind('mousemove touchmove touchstart', function(e) {
        var chart,
            point,
            i,
            event;

        for (i = 0; i < Highcharts.charts.length; i = i + 1) {
            chart = Highcharts.charts[i];
            event = chart.pointer.normalize(e.originalEvent); // Find coordinates within the chart
            points = [chart.series[0].searchPoint(event, true),
                      chart.series[1].searchPoint(event, true)]; // Get the hovered point

            if (points[0] && points[1]) {
                points[0].onMouseOver(); // Show the hover marker
                points[1].onMouseOver(); // Show the hover marker
                chart.tooltip.refresh(points); // Show the tooltip
                chart.xAxis[0].drawCrosshair(e, points[0]); // Show the crosshair
            }
        }
    });

    Highcharts.setOptions({
        exporting: {
            fallbackToExportServer: false // Ensure the export happens on the client side or not at all
        },
        global: {
            useUTC: false
        },
        tooltip: {
            shared: true,
            formatter: function () {
                return '<b>' + this.points[0].series.name + ':</b> ' + Highcharts.numberFormat(this.points[0].y, -1) + '<br/>' +
                        '<b>' + this.points[1].series.name + ':</b> ' + Highcharts.numberFormat(this.points[1].y, -1) + '<br/>';
            },
            borderColor: '#000000',
            style: {
                fontSize: '16px'
            }
        },
        title: {
            text: ''
        },
        legend: {
            enabled: false
        }
    });

    mainChart = Highcharts.chart('container', {
        chart: {
            type: 'spline',
            animation: Highcharts.svg,
            backgroundColor: {
                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                stops: [
                    [0, '#ffffff'],
                    [.190, '#ffffff'],
                    [.195, '#efe8e0'],
                    [.395, '#efe8e0'],
                    [.400, '#fef1da'],
                    [.575, '#fef1da'],
                    [.600, '#d9ebd9'],
                    [.800, '#d9ebd9'],
                    [.100, '#ffffff']
                ]
            },
        },
        xAxis: {
            title: {
                text: 'Minutes'
            },
            max: 11,
            min: 0,
            gridLineColor: '#e5e5e5',
            gridLineWidth: 1,
        },
        yAxis: {
            title: {
                text: 'Temperature'
            },
            max: 550,
            gridLineColor: '#e5e5e5',
        },
        exporting:{
            chartOptions:{
                legend:{
                    enabled:true
                }
            },
            enabled: false,
            sourceWidth: 1200,
            sourceHeight: 600
        },
        series: [{
            name: 'Environment Temperature',
            color: 'red',
            data: [[0.027, 431.01935], [0.054, 432.01371], [0.081, 433.9464], [0.108, 435.12522], [0.135, 436.71408], [0.162, 439.74731], [0.189, 441.78421], [0.216, 443.59901], [0.243, 445.53122], [0.27, 447.6582], [0.29700000000000004, 451.22394], [0.32400000000000007, 450.1515], [0.3510000000000001, 449.63447], [0.3780000000000001, 449.15108], [0.40500000000000014, 447.94069], [0.43200000000000016, 446.45879], [0.4590000000000002, 444.27059], [0.4860000000000002, 443.52941], [0.5130000000000002, 441.79559], [0.5400000000000003, 439.96236], [0.5670000000000003, 438.19765], [0.5940000000000003, 436.39985], [0.6210000000000003, 434.0], [0.6480000000000004, 432.2], [0.6750000000000004, 430.11875], [0.7020000000000004, 427.47559], [1.0, 425.04222], [1.027, 422.92139], [1.0539999999999998, 420.27567], [1.0809999999999997, 417.72973], [1.1079999999999997, 415.54561], [1.1349999999999996, 412.0858], [1.1619999999999995, 410.58036], [1.1889999999999994, 408.79877], [1.2159999999999993, 405.88434], [1.2429999999999992, 404.23027], [1.2699999999999991, 402.27064], [1.296999999999999, 399.80221], [1.323999999999999, 397.71889], [1.3509999999999989, 396.12419], [1.3779999999999988, 394.3807], [1.4049999999999987, 392.59879], [1.4319999999999986, 391.24618], [1.4589999999999985, 389.56133], [1.4859999999999984, 388.47258], [1.5129999999999983, 387.11033], [1.5399999999999983, 385.38022], [1.5669999999999982, 384.38626], [1.593999999999998, 383.1286], [1.620999999999998, 381.76697], [1.647999999999998, 381.23544], [1.6749999999999978, 380.52699], [1.7019999999999977, 379.47038], [2.0, 378.7294], [2.027, 377.66353], [2.0540000000000003, 377.15221], [2.0810000000000004, 375.94076], [2.1080000000000005, 375.80792], [2.1350000000000007, 374.56277], [2.162000000000001, 374.03517], [2.189000000000001, 374.00198], [2.216000000000001, 373.55007], [2.243000000000001, 372.34063], [2.2700000000000014, 372.20791], [2.2970000000000015, 372.20027], [2.3240000000000016, 372.20002], [2.3510000000000018, 370.90625], [2.378000000000002, 370.41758], [2.405000000000002, 370.4011], [2.432000000000002, 370.40006], [2.4590000000000023, 370.4], [2.4860000000000024, 370.4], [2.5130000000000026, 369.725], [2.5400000000000027, 368.67031], [2.567000000000003, 368.60439], [2.594000000000003, 368.60014], [2.621000000000003, 368.60001], [2.6480000000000032, 368.6], [2.6750000000000034, 368.6], [2.7020000000000035, 368.6], [3.0, 368.6], [3.027, 368.6], [3.0540000000000003, 368.6], [3.0810000000000004, 368.6], [3.1080000000000005, 368.6], [3.1350000000000007, 368.6], [3.162000000000001, 368.6], [3.189000000000001, 368.6], [3.216000000000001, 368.6], [3.243000000000001, 368.6], [3.2700000000000014, 368.9375], [3.2970000000000015, 369.275], [3.3240000000000016, 370.32969], [3.3510000000000018, 370.3978], [3.378000000000002, 370.39986], [3.405000000000002, 370.39999], [3.432000000000002, 371.075], [3.4590000000000023, 372.12969], [3.4860000000000024, 372.19561], [3.5130000000000026, 372.19986], [3.5400000000000027, 372.19999], [3.567000000000003, 372.2], [3.594000000000003, 373.4375], [3.621000000000003, 373.96484], [3.6480000000000032, 373.99802], [3.6750000000000034, 374.44993], [3.7020000000000035, 376.33437], [4.0, 377.52881], [4.027, 377.59753], [4.054, 377.59985], [4.081, 378.38749], [4.1080000000000005, 379.36484], [4.135000000000001, 379.3978], [4.162000000000001, 379.39988], [4.189000000000001, 380.6375], [4.216000000000001, 381.16484], [4.243000000000001, 381.19802], [4.270000000000001, 381.64993], [4.2970000000000015, 382.85937], [4.324000000000002, 382.99209], [4.351000000000002, 382.99973], [4.378000000000002, 383.67498], [4.405000000000002, 384.73672], [4.432000000000002, 384.7978], [4.459000000000002, 385.47486], [4.486000000000002, 386.53671], [4.513000000000003, 386.5978], [4.540000000000003, 386.59986], [4.567000000000003, 388.14687], [4.594000000000003, 388.39121], [4.621000000000003, 388.39945], [4.648000000000003, 389.18747], [4.675000000000003, 390.16484], [4.7020000000000035, 390.1978], [5.0, 390.19988], [5.027, 391.71875], [5.054, 391.98242], [5.081, 391.99945], [5.1080000000000005, 393.23747], [5.135000000000001, 393.76484], [5.162000000000001, 393.7989], [5.189000000000001, 394.24993], [5.216000000000001, 395.45937], [5.243000000000001, 395.59561], [5.270000000000001, 395.59973], [5.2970000000000015, 396.83748], [5.324000000000002, 397.38242], [5.351000000000002, 397.3989], [5.378000000000002, 398.07493], [5.405000000000002, 399.16484], [5.432000000000002, 399.1978], [5.459000000000002, 399.19986], [5.486000000000002, 400.85937], [5.513000000000003, 400.99121], [5.540000000000003, 401.44945], [5.567000000000003, 402.72967], [5.594000000000003, 402.7956], [5.621000000000003, 403.47473], [5.648000000000003, 404.56484], [5.675000000000003, 404.5978], [5.7020000000000035, 405.27486], [6.0, 406.36484], [6.027, 406.3978], [6.054, 407.07486], [6.081, 408.16484], [6.1080000000000005, 408.1978], [6.135000000000001, 409.43736], [6.162000000000001, 409.98242], [6.189000000000001, 409.9989], [6.216000000000001, 409.99993], [6.243000000000001, 411.51875], [6.270000000000001, 411.78242], [6.2970000000000015, 411.79901], [6.324000000000002, 411.79997], [6.351000000000002, 413.31875], [6.378000000000002, 413.58418], [6.405000000000002, 413.59945], [6.432000000000002, 413.59997], [6.459000000000002, 414.3875], [6.486000000000002, 415.36484], [6.513000000000003, 415.3978], [6.540000000000003, 415.39988], [6.567000000000003, 415.4], [6.594000000000003, 416.6375], [6.621000000000003, 417.84336], [6.648000000000003, 418.92859], [6.675000000000003, 418.99554], [6.7020000000000035, 418.99975], [7.0, 419.67499], [7.027, 420.72969], [7.054, 420.79604], [7.081, 420.79986], [7.1080000000000005, 420.79999], [7.135000000000001, 421.475], [7.162000000000001, 422.52969], [7.189000000000001, 422.59561], [7.216000000000001, 422.59975], [7.243000000000001, 422.59999], [7.270000000000001, 423.275], [7.2970000000000015, 424.33672], [7.324000000000002, 424.3978], [7.351000000000002, 424.39986], [7.378000000000002, 424.39999], [7.405000000000002, 424.4], [7.432000000000002, 425.6375], [7.459000000000002, 426.18242], [7.486000000000002, 426.1989], [7.513000000000003, 426.19993], [7.540000000000003, 426.2], [7.567000000000003, 426.2], [7.594000000000003, 427.71875], [7.621000000000003, 427.99121], [7.648000000000003, 427.99945], [7.675000000000003, 427.99997], [7.7020000000000035, 428.0], [8.0, 428.45], [8.027, 429.65937], [8.053999999999998, 429.79561], [8.080999999999998, 429.79973], [8.107999999999997, 429.79998], [8.134999999999996, 431.0375], [8.161999999999995, 431.56484], [8.188999999999995, 431.5978], [8.215999999999994, 431.59993], [8.242999999999993, 432.05], [8.269999999999992, 433.25937], [8.296999999999992, 433.39561], [8.323999999999991, 433.39973], [8.35099999999999, 433.39998], [8.37799999999999, 434.6375], [8.404999999999989, 435.16484], [8.431999999999988, 435.1978], [8.458999999999987, 435.19993], [8.485999999999986, 436.71875], [8.512999999999986, 436.98418], [8.539999999999985, 436.99945], [8.566999999999984, 436.99997], [8.593999999999983, 438.54687], [8.620999999999983, 438.79121], [8.647999999999982, 439.24945], [8.674999999999981, 440.47341], [8.70199999999998, 440.5956], [9.0, 440.59973], [9.027, 440.59998], [9.053999999999998, 441.275], [9.080999999999998, 442.32969]]
        }, {
            name: 'Bean Temperature',
            color: '#020c7d',
            data: [[0.027, 385.17855], [0.054, 386.45491], [0.081, 388.13871], [0.108, 389.90968], [0.135, 390.85685], [0.162, 393.87678], [0.189, 395.9423], [0.216, 397.25264], [0.243, 398.91415], [0.27, 400.41963], [0.29700000000000004, 401.86371], [0.32400000000000007, 393.96648], [0.3510000000000001, 379.63541], [0.3780000000000001, 358.14486], [0.40500000000000014, 340.49655], [0.43200000000000016, 323.19353], [0.4590000000000002, 302.04355], [0.4860000000000002, 290.35897], [0.5130000000000002, 277.98494], [0.5400000000000003, 264.9964], [0.5670000000000003, 255.53103], [0.5940000000000003, 248.58319], [0.6210000000000003, 239.91822], [0.6480000000000004, 234.33239], [0.6750000000000004, 229.08952], [0.7020000000000004, 223.67155], [1.0, 219.81697], [1.027, 216.76356], [1.0539999999999998, 214.96136], [1.0809999999999997, 212.63509], [1.1079999999999997, 211.36469], [1.1349999999999996, 210.2364], [1.1619999999999995, 210.20227], [1.1889999999999994, 210.20014], [1.2159999999999993, 210.2], [1.2429999999999992, 210.2], [1.2699999999999991, 210.2], [1.296999999999999, 210.2], [1.323999999999999, 210.875], [1.3509999999999989, 211.93672], [1.3779999999999988, 213.2353], [1.4049999999999987, 213.76471], [1.4319999999999986, 215.09176], [1.4589999999999985, 216.03235], [1.4859999999999984, 217.25827], [1.5129999999999983, 218.68578], [1.5399999999999983, 219.85715], [1.5669999999999982, 220.92857], [1.593999999999998, 221.78348], [1.620999999999998, 224.1147], [1.647999999999998, 226.25717], [1.6749999999999978, 227.06697], [1.7019999999999977, 228.12941], [2.0, 229.71434], [2.027, 230.77143], [2.0540000000000003, 232.21429], [2.0810000000000004, 233.45714], [2.1080000000000005, 234.37946], [2.1350000000000007, 235.36456], [2.162000000000001, 236.91654], [2.189000000000001, 237.85906], [2.216000000000001, 238.92913], [2.243000000000001, 239.67057], [2.2700000000000014, 241.18647], [2.2970000000000015, 242.45717], [2.3240000000000016, 243.82857], [2.3510000000000018, 244.81786], [2.378000000000002, 246.05826], [2.405000000000002, 246.64114], [2.432000000000002, 247.87294], [2.4590000000000023, 249.51434], [2.4860000000000024, 250.23215], [2.5130000000000026, 251.47243], [2.5400000000000027, 252.27057], [2.567000000000003, 253.32941], [2.594000000000003, 254.91654], [2.621000000000003, 255.63228], [2.6480000000000032, 256.85827], [2.6750000000000034, 257.67057], [2.7020000000000035, 258.72941], [3.0, 260.03309], [3.027, 260.58228], [3.0540000000000003, 262.11764], [3.0810000000000004, 262.38235], [3.1080000000000005, 264.05882], [3.1350000000000007, 264.19118], [3.162000000000001, 265.49325], [3.189000000000001, 266.4324], [3.216000000000001, 267.65828], [3.243000000000001, 267.79114], [3.2700000000000014, 269.4591], [3.2970000000000015, 270.04119], [3.3240000000000016, 271.25882], [3.3510000000000018, 272.07059], [3.378000000000002, 273.12941], [3.405000000000002, 273.64559], [3.432000000000002, 274.92955], [3.4590000000000023, 275.6706], [3.4860000000000024, 276.72941], [3.5130000000000026, 278.03529], [3.5400000000000027, 278.56471], [3.567000000000003, 280.11654], [3.594000000000003, 280.39114], [3.621000000000003, 281.63695], [3.6480000000000032, 282.16833], [3.6750000000000034, 283.8864], [3.7020000000000035, 285.62415], [4.0, 287.08386], [4.027, 288.03208], [4.054, 289.25825], [4.081, 290.06703], [4.1080000000000005, 291.12941], [4.135000000000001, 291.19559], [4.162000000000001, 292.74663], [4.189000000000001, 293.6662], [4.216000000000001, 294.72914], [4.243000000000001, 295.47101], [4.270000000000001, 296.52955], [4.2970000000000015, 297.2706], [4.324000000000002, 298.33647], [4.351000000000002, 299.91654], [4.378000000000002, 300.18228], [4.405000000000002, 301.74588], [4.432000000000002, 301.99118], [4.459000000000002, 303.5182], [4.486000000000002, 304.45915], [4.513000000000003, 305.52914], [4.540000000000003, 306.27057], [4.567000000000003, 307.33647], [4.594000000000003, 308.63529], [4.621000000000003, 309.16471], [4.648000000000003, 310.74489], [4.675000000000003, 310.99114], [4.7020000000000035, 312.23695], [5.0, 313.21833], [5.027, 314.45828], [5.054, 314.59114], [5.081, 316.2591], [5.1080000000000005, 317.74119], [5.135000000000001, 319.85882], [5.162000000000001, 319.99559], [5.189000000000001, 321.23722], [5.216000000000001, 321.76483], [5.243000000000001, 323.45828], [5.270000000000001, 323.59114], [5.2970000000000015, 325.1182], [5.324000000000002, 325.84119], [5.351000000000002, 327.05882], [5.378000000000002, 327.64118], [5.405000000000002, 328.92941], [5.432000000000002, 329.67059], [5.459000000000002, 330.72941], [5.486000000000002, 332.03529], [5.513000000000003, 332.56471], [5.540000000000003, 332.59779], [5.567000000000003, 334.25931], [5.594000000000003, 335.06621], [5.621000000000003, 336.12914], [5.648000000000003, 337.43529], [5.675000000000003, 337.96471], [5.7020000000000035, 339.23529], [6.0, 340.23235], [6.027, 341.45827], [6.054, 342.26614], [6.081, 343.36457], [6.1080000000000005, 344.63529], [6.135000000000001, 345.16471], [6.162000000000001, 346.85827], [6.189000000000001, 346.99114], [6.216000000000001, 348.5182], [6.243000000000001, 349.24119], [6.270000000000001, 350.45882], [6.2970000000000015, 351.26706], [6.324000000000002, 352.32941], [6.351000000000002, 352.84559], [6.378000000000002, 354.07319], [6.405000000000002, 354.1956], [6.432000000000002, 355.71847], [6.459000000000002, 355.98416], [6.486000000000002, 357.23695], [6.513000000000003, 357.76481], [6.540000000000003, 358.58552], [6.567000000000003, 359.56478], [6.594000000000003, 359.5978], [6.621000000000003, 361.82175], [6.648000000000003, 363.57089], [6.675000000000003, 364.85443], [6.7020000000000035, 365.66681], [7.0, 366.7294], [7.027, 366.79559], [7.054, 368.0935], [7.081, 368.58241], [7.1080000000000005, 368.5989], [7.135000000000001, 369.89369], [7.162000000000001, 370.38242], [7.189000000000001, 370.3989], [7.216000000000001, 371.94681], [7.243000000000001, 372.19121], [7.270000000000001, 372.64945], [7.2970000000000015, 373.87341], [7.324000000000002, 373.9956], [7.351000000000002, 375.23723], [7.378000000000002, 375.76834], [7.405000000000002, 375.7989], [7.432000000000002, 375.79993], [7.459000000000002, 377.45937], [7.486000000000002, 377.59121], [7.513000000000003, 378.27445], [7.540000000000003, 379.36483], [7.567000000000003, 379.8478], [7.594000000000003, 381.05924], [7.621000000000003, 381.1956], [7.648000000000003, 382.71848], [7.675000000000003, 382.9824], [7.7020000000000035, 384.5182], [8.0, 384.78239], [8.027, 385.2489], [8.053999999999998, 386.52965], [8.080999999999998, 387.2706], [8.107999999999997, 388.32941], [8.134999999999996, 389.63529], [8.161999999999995, 390.16471], [8.188999999999995, 390.87279], [8.215999999999994, 391.96477], [8.242999999999993, 393.51655], [8.269999999999992, 393.78228], [8.296999999999992, 395.45882], [8.323999999999991, 395.59118], [8.35099999999999, 397.1182], [8.37799999999999, 398.06619], [8.404999999999989, 399.12914], [8.431999999999988, 399.87057], [8.458999999999987, 401.41471], [8.485999999999986, 402.65717], [8.512999999999986, 403.24197], [8.539999999999985, 404.4591], [8.566999999999984, 404.59119], [8.593999999999983, 405.387], [8.620999999999983, 406.36483], [8.647999999999982, 406.3978], [8.674999999999981, 406.39988], [8.70199999999998, 405.725], [9.0, 404.67031], [9.027, 404.60396], [9.053999999999998, 404.60014], [9.080999999999998, 403.92501]]
        }]
    });

    auxChart = Highcharts.chart('auxiliary', {
        chart: {
            type: 'spline',
            animation: Highcharts.svg,
            backgroundColor: '#f5f5f5',
        },
        xAxis: {
            max: 11,
            min: 0,
        },
        yAxis: {
            max: 100,
            gridLineColor: '#e5e5e5',
            title: {
                text: ''
            },
        },
        exporting:{
            chartOptions:{
                legend:{
                    enabled:true
                }
            },
            enabled: false,
            sourceWidth: 1200,
            sourceHeight: 200
        },
        series: [{
            name: 'Fan',
            type: 'spline',
            dashStyle: 'dash',
            data: [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0], [5, 10], [6, 40], [7, 75], [8, 75], [9, 100]]
        }, {
            name: 'Heat',
            type: 'spline',
            dashStyle: 'dash',
            data: [[0, 100], [1, 0], [2, 80], [3, 90], [4, 100], [5, 100], [6, 100], [7, 100], [8, 100], [9, 100]]
        }]
    });

    $('#export-png').click(function () {
      Highcharts.exportCharts([mainChart, auxChart]);
    });
});
